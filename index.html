<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ Ù†Ù‚Ø´Ù‡â€ŒÛŒ Ø¬Ø§ÛŒØ²Ù‡â€ŒÙ‡Ø§</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  *{box-sizing:border-box;direction:rtl}
  html,body{margin:0;padding:0;height:100%;font-family:'Vazirmatn',sans-serif;background:#0b1220;overflow:hidden;color:#fff}
  #map{height:100%;width:100%;filter:brightness(0.85) saturate(1.2)}
  .hud{position:absolute;top:20px;left:50%;transform:translateX(-50%);display:flex;gap:12px;z-index:10;}
  .hud-item{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);padding:10px 18px;border-radius:16px;backdrop-filter:blur(8px);box-shadow:0 2px 10px rgba(0,0,0,0.4);font-size:15px;}
  .hud-item span{color:#00e6b8;font-weight:bold;font-size:17px;}
  .bottom-actions{position:absolute;bottom:24px;left:50%;transform:translateX(-50%);display:flex;gap:16px;z-index:10;}
  .floating-btn{background:linear-gradient(135deg,#00e6b8,#0075ff);color:#fff;padding:14px 26px;border-radius:40px;font-size:16px;font-weight:600;border:none;cursor:pointer;box-shadow:0 6px 25px rgba(0,230,184,0.4);transition:all .3s ease;min-width:140px;}
  .btn-disabled{opacity:0.45;pointer-events:none;filter:grayscale(0.3);}
  .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:999;}
  .card{background:rgba(15,22,40,0.9);border-radius:20px;padding:30px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.05);}
  .card h2{margin-bottom:10px;color:#00e6b8}
  .reward-marker {
    width: 26px; height: 26px;
    background: conic-gradient(from 0deg, #ffcc00, #ffaa00, #ffcc00);
    border-radius: 50%;
    border:2px solid #fff;
    box-shadow: 0 0 20px 6px rgba(255, 230, 80, 0.7);
    animation: spin 3s linear infinite;
  }
  @keyframes spin {to{transform:rotate(360deg)}}
  .user-marker {width:20px;height:20px;background:radial-gradient(circle,#00e6b8 30%,#0075ff 70%);border-radius:50%;box-shadow:0 0 20px 8px rgba(0,230,184,0.7);border:2px solid #fff;}
</style>
</head>
<body>
<div id="map"></div>

<div class="hud">
  <div class="hud-item">Ù‚ÙÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²Ø´Ø¯Ù‡: <span id="count">0</span>/10</div>
  <div class="hud-item">Ù†Ø´Ø§Ù†Ú¯Ø±Ù‡Ø§: <span id="total">6</span></div>
</div>

<div class="bottom-actions">
  <button id="resetBtn" class="floating-btn">Reset</button>
  <a id="withdrawBtn" class="floating-btn btn-disabled" href="#" target="_blank">Withdraw</a>
</div>

<div id="modal" class="modal">
  <div class="card">
    <h2>ğŸ‰ Ù‚ÙÙ„ Ø¨Ø§Ø² Ø´Ø¯!</h2>
    <p>Ø¢ÙØ±ÛŒÙ†! ÛŒÚ© Ù‚ÙÙ„ Ø¯ÛŒÚ¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯ÛŒ.</p>
    <button id="closeModal">Ø§Ø¯Ø§Ù…Ù‡</button>
  </div>
</div>

<div id="winModal" class="modal">
  <div class="card">
    <h2>ğŸ† ØªØ¨Ø±ÛŒÚ©!</h2>
    <p>ØªÙˆ ØªÙˆÙ†Ø³ØªÛŒ Û±Û° Ù‚ÙÙ„ Ø±Ùˆ Ø¨Ø§Ø² Ú©Ù†ÛŒ!<br>Ù‡Ø¯ÛŒÙ‡â€ŒØ§Øª Ù…Ù†ØªØ¸Ø±ØªÙ‡ ğŸ’</p>
    <button onclick="window.location.reload()">Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ¨Ø§Ø±Ù‡</button>
  </div>
</div>

<script>
const map = L.map('map').setView([32.0,53.0],6);
L.tileLayer(`https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=wtyVynedWDK2q9aMHfGI`,{
  attribution:'&copy; MapTiler & OpenStreetMap'
}).addTo(map);

let markers=[], unlockedIds=JSON.parse(localStorage.getItem("unlockedMarkers")||"[]"), userMarker, userCircle, routeLine;
const withdrawBtn=document.getElementById("withdrawBtn");

function getRandomDistanceLatLng(centerLat,centerLng,minM,maxM){
  const R=6371000;
  const d=Math.random()*(maxM-minM)+minM;
  const brng=Math.random()*2*Math.PI;
  const newLat=centerLat+(d/R)*(180/Math.PI)*Math.cos(brng);
  const newLng=centerLng+(d/R)*(180/Math.PI)/Math.cos(centerLat*Math.PI/180)*Math.sin(brng);
  return {lat:newLat,lng:newLng};
}

function createRewards(n,center){
  markers.forEach(m=>m.remove?.());
  markers=[];
  for(let i=0;i<n;i++){
    const pos=getRandomDistanceLatLng(center.lat,center.lng,100,5000);
    const id=`${pos.lat.toFixed(5)},${pos.lng.toFixed(5)}`;
    const marker=L.marker([pos.lat,pos.lng],{icon:L.divIcon({className:'reward-marker'})});
    marker.id=id;
    marker.addTo(map);
    markers.push(marker);
  }
  document.getElementById("total").innerText=n;
  document.getElementById("count").innerText=unlockedIds.length;
  updateWithdrawState();
}

function distance(lat1,lon1,lat2,lon2){
  const R=6371e3;
  const Ï†1=lat1*Math.PI/180, Ï†2=lat2*Math.PI/180;
  const Î”Ï†=(lat2-lat1)*Math.PI/180, Î”Î»=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(Î”Ï†/2)**2+Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function showModal(sel){
  const el=document.querySelector(sel);
  el.style.display='flex';
  el.querySelector('button').addEventListener('click',()=>el.style.display='none',{once:true});
}

function updateWithdrawState(){
  if(unlockedIds.length>=10){
    withdrawBtn.classList.remove('btn-disabled');
    withdrawBtn.href='https://t.me/Whale_Armin';
  } else {
    withdrawBtn.classList.add('btn-disabled');
    withdrawBtn.href='#';
  }
}

function updateUserLocation(pos){
  const lat=pos.coords.latitude, lng=pos.coords.longitude;
  if(!userMarker){
    userMarker=L.marker([lat,lng],{icon:L.divIcon({className:'user-marker'})}).addTo(map);
    userCircle=L.circle([lat,lng],{radius:50,color:'#00e6b8',fillColor:'#00e6b8',fillOpacity:0.1}).addTo(map);
    map.setView([lat,lng],15);
    createRewards(6,{lat,lng});
  } else {
    userMarker.setLatLng([lat,lng]);
    userCircle.setLatLng([lat,lng]);
  }

  // Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ØµÙ„Ù‡ Ø¨Ø§ Ø¬Ø§ÛŒØ²Ù‡â€ŒÙ‡Ø§
  let closest = null, minDist = Infinity;
  markers.forEach(marker=>{
    const dist=distance(lat,lng,marker.getLatLng().lat,marker.getLatLng().lng);
    if(dist<minDist){ minDist=dist; closest=marker; }

    if(!unlockedIds.includes(marker.id) && dist<50){
      marker.remove();
      unlockedIds.push(marker.id);
      localStorage.setItem("unlockedMarkers",JSON.stringify(unlockedIds));
      document.getElementById("count").innerText=unlockedIds.length;
      updateWithdrawState();
      showModal("#modal");
      if(unlockedIds.length>=10)setTimeout(()=>showModal("#winModal"),700);
    }
  });

  // Ø±Ø³Ù… Ù…Ø³ÛŒØ± Ø§Ú¯Ø± Ø¨ÛŒÙ† 100 ØªØ§ 2000 Ù…ØªØ± Ø¨Ø§Ø´Ù‡
  if(closest && minDist>100 && minDist<2000){
    const points=[ [lat,lng], [closest.getLatLng().lat, closest.getLatLng().lng] ];
    if(routeLine) routeLine.remove();
    routeLine = L.polyline(points,{color:'#0099ff',weight:6,opacity:0.9, dashArray:'10,6'}).addTo(map);
  } else {
    if(routeLine){ routeLine.remove(); routeLine=null; }
  }
}

document.getElementById("resetBtn").addEventListener("click",()=>{
  if(userMarker){
    const latlng=userMarker.getLatLng();
    map.setView(latlng,16,{animate:true});
    map.scrollWheelZoom.disable();
    map.doubleClickZoom.disable();
    map.touchZoom.disable();
    map.boxZoom.disable();
    map.zoomControl.remove();
  }
});

if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(pos=>{
    updateUserLocation(pos);
    navigator.geolocation.watchPosition(updateUserLocation,()=>{}, {enableHighAccuracy:true});
  });
} else {alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.");}
</script>
</body>
</html>
