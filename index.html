<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ Ù†Ù‚Ø´Ù‡â€ŒÛŒ Ø¬Ø§ÛŒØ²Ù‡â€ŒÙ‡Ø§</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    *{box-sizing:border-box;direction:rtl}
    html,body{margin:0;padding:0;height:100%;font-family:'Vazirmatn',sans-serif;background:#0b1220;overflow:hidden;color:#fff}
    #map{height:100%;width:100%;filter:brightness(0.85) saturate(1.2)}
    #overlay{
      position:absolute;top:0;left:0;width:100%;height:100%;
      pointer-events:none;background:radial-gradient(circle at center,rgba(255,255,255,0.05),transparent 80%);
      opacity:0.25;
    }
    .hud{
      position:absolute;top:20px;left:50%;transform:translateX(-50%);
      display:flex;gap:12px;z-index:10;
    }
    .hud-item{
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.1);
      padding:10px 18px;border-radius:16px;
      backdrop-filter:blur(8px);
      box-shadow:0 2px 10px rgba(0,0,0,0.4);
      font-size:15px;
      transition:all .3s ease;
    }
    .hud-item span{color:#00e6b8;font-weight:bold;font-size:17px;}
    .hud-item:hover{transform:scale(1.05);background:rgba(255,255,255,0.15)}

    .bottom-actions {
      position: absolute;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 16px;
      z-index: 10;
    }

    .floating-btn{
      background:linear-gradient(135deg,#00e6b8,#0075ff);
      color:#fff;padding:14px 26px;border-radius:40px;
      font-size:16px;font-weight:600;border:none;cursor:pointer;
      box-shadow:0 6px 25px rgba(0,230,184,0.4);
      transition:all .3s ease;
      min-width:140px;
      display:inline-flex;align-items:center;justify-content:center;text-decoration:none;
    }
    .floating-btn:hover{transform:scale(1.05);box-shadow:0 8px 30px rgba(0,230,184,0.6);}
    .btn-disabled{opacity:0.45;pointer-events:none;filter:grayscale(0.3);}

    .modal{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.6);display:none;
      align-items:center;justify-content:center;z-index:999;
    }
    .card{
      background:rgba(15,22,40,0.9);
      border-radius:20px;
      padding:30px;
      text-align:center;
      box-shadow:0 10px 40px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.05);
      backdrop-filter:blur(10px);
      animation:pop .4s ease;
      max-width:350px;
    }
    @keyframes pop{0%{transform:scale(0.7);opacity:0}100%{transform:scale(1);opacity:1}}
    .card h2{margin-bottom:10px;color:#00e6b8}
    .card p{color:#ccc;margin-bottom:20px}
    .card button{background:linear-gradient(135deg,#00e6b8,#0075ff);border:none;color:#fff;padding:10px 20px;border-radius:8px;font-size:15px;cursor:pointer}
    .card button:hover{opacity:.9}

    /* Ù†Ø´Ø§Ù†Ú¯Ø± Ø·Ù„Ø§ÛŒÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ */
    .glow-marker {
      border-radius:50%;
      box-shadow:0 0 25px 6px rgba(255,210,122,0.8), 0 0 60px 20px rgba(255,210,122,0.4);
      animation:glowPulse 2s infinite alternate;
    }
    @keyframes glowPulse {
      from {transform:scale(1);opacity:1;}
      to {transform:scale(1.2);opacity:0.9;}
    }

    .user-marker {
      width: 18px; height: 18px;
      background: radial-gradient(circle, #00e6b8 30%, #0075ff 70%);
      border-radius: 50%;
      box-shadow: 0 0 15px 6px rgba(0,230,184,0.5);
      animation: pulse 2s infinite alternate;
      border: 2px solid #fff;
    }
    @keyframes pulse {
      from {transform: scale(1); box-shadow: 0 0 15px 6px rgba(0,230,184,0.5);}
      to {transform: scale(1.3); box-shadow: 0 0 25px 12px rgba(0,230,184,0.8);}
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="overlay"></div>

  <div class="hud">
    <div class="hud-item">Ù‚ÙÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²Ø´Ø¯Ù‡: <span id="count">0</span>/10</div>
    <div class="hud-item">Ù†Ø´Ø§Ù†Ú¯Ø±Ù‡Ø§: <span id="total">20</span></div>
  </div>

  <div class="bottom-actions">
    <button id="resetBtn" class="floating-btn">Reset</button>
    <a id="withdrawBtn" class="floating-btn btn-disabled" href="#" target="_blank">Withdraw</a>
  </div>

  <div id="modal" class="modal">
    <div class="card">
      <h2>ğŸ‰ Ù‚ÙÙ„ Ø¨Ø§Ø² Ø´Ø¯!</h2>
      <p>Ø¢ÙØ±ÛŒÙ†! ÛŒÚ© Ù‚ÙÙ„ Ø¯ÛŒÚ¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯ÛŒ.</p>
      <button id="closeModal">Ø§Ø¯Ø§Ù…Ù‡</button>
    </div>
  </div>

  <div id="winModal" class="modal">
    <div class="card">
      <h2>ğŸ† ØªØ¨Ø±ÛŒÚ©!</h2>
      <p>ØªÙˆ ØªÙˆÙ†Ø³ØªÛŒ Û±Û° Ù‚ÙÙ„ Ø±Ùˆ Ø¨Ø§Ø² Ú©Ù†ÛŒ!<br>Ù‡Ø¯ÛŒÙ‡â€ŒØ§Øª Ù…Ù†ØªØ¸Ø±ØªÙ‡ ğŸ’</p>
      <button onclick="window.location.reload()">Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ¨Ø§Ø±Ù‡</button>
    </div>
  </div>

  <script>
    const map = L.map('map').setView([32.0, 53.0], 6); // Ù†Ù…Ø§ÛŒØ´ Ø§ÙˆÙ„ÛŒÙ‡ Ø±ÙˆÛŒ Ø§ÛŒØ±Ø§Ù†

    L.tileLayer(`https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=wtyVynedWDK2q9aMHfGI`, {
      attribution: '&copy; <a href="https://www.maptiler.com/">MapTiler</a> & <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
    }).addTo(map);

    let markers = [], unlockedIds = JSON.parse(localStorage.getItem("unlockedMarkers") || "[]"), userMarker, userCircle;
    const withdrawBtn = document.getElementById("withdrawBtn");

    function randomPoints(n, center){
      markers.forEach(m=>m.remove?.());
      markers=[];
      const latRange=0.15, lngRange=0.15;
      for(let i=0;i<n;i++){
        const lat=center.lat+(Math.random()-0.5)*latRange;
        const lng=center.lng+(Math.random()-0.5)*lngRange;
        const id=`${lat.toFixed(5)},${lng.toFixed(5)}`;
        const color=unlockedIds.includes(id)?'#00e6b8':'#ffd27a';
        const marker=L.circleMarker([lat,lng],{
          radius:10, color:color, fillColor:color, fillOpacity:0.9, className:'glow-marker'
        }).addTo(map);
        marker.id=id;
        markers.push(marker);
      }
      document.getElementById("total").innerText=n;
      document.getElementById("count").innerText=unlockedIds.length;
      updateWithdrawState();
    }

    function distance(lat1,lon1,lat2,lon2){
      const R=6371e3;
      const Ï†1=lat1*Math.PI/180, Ï†2=lat2*Math.PI/180;
      const Î”Ï†=(lat2-lat1)*Math.PI/180;
      const Î”Î»=(lon2-lon1)*Math.PI/180;
      const a=Math.sin(Î”Ï†/2)**2+Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    function updateUserLocation(pos){
      const lat=pos.coords.latitude, lng=pos.coords.longitude;
      const userPos = [lat, lng];

      if(!userMarker){
        const icon=L.divIcon({className:'user-marker'});
        userMarker=L.marker(userPos,{icon}).addTo(map);
        userCircle=L.circle(userPos,{radius:50,color:'#00e6b8',fillColor:'#00e6b8',fillOpacity:0.1}).addTo(map);
        map.setView(userPos, 16); // Ø²ÙˆÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ø±ÙˆÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±
        randomPoints(20, {lat, lng});
      } else {
        userMarker.setLatLng(userPos);
        userCircle.setLatLng(userPos);
      }

      markers.forEach(marker=>{
        if(!unlockedIds.includes(marker.id)){
          const dist=distance(lat,lng,marker.getLatLng().lat,marker.getLatLng().lng);
          if(dist<50){
            marker.setStyle({color:'#00e6b8',fillColor:'#00e6b8'});
            unlockedIds.push(marker.id);
            localStorage.setItem("unlockedMarkers", JSON.stringify(unlockedIds));
            document.getElementById("count").innerText=unlockedIds.length;
            updateWithdrawState();
            showModal("#modal");
            if(unlockedIds.length>=10)setTimeout(()=>showModal("#winModal"),700);
          }
        }
      });
    }

    function showModal(sel){
      const el=document.querySelector(sel);
      el.style.display='flex';
      el.querySelector('button').addEventListener('click',()=>el.style.display='none',{once:true});
    }

    function updateWithdrawState(){
      if(unlockedIds.length>=10){
        withdrawBtn.classList.remove('btn-disabled');
        withdrawBtn.href='https://t.me/Whale_Armin';
      }else{
        withdrawBtn.classList.add('btn-disabled');
        withdrawBtn.href='#';
      }
    }

    document.getElementById("resetBtn").addEventListener("click", ()=>{
      if(userMarker){
        const latlng = userMarker.getLatLng();
        map.setView(latlng, 16);
        map.options.scrollWheelZoom = false;
        map.options.doubleClickZoom = false;
        map.options.touchZoom = false;
        map.options.boxZoom = false;
        map.options.zoomControl = false;
      }
    });

    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        updateUserLocation(pos);
        navigator.geolocation.watchPosition(updateUserLocation, ()=>{}, {enableHighAccuracy:true});
      });
    } else {
      alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.");
    }
  </script>
</body>
</html>
